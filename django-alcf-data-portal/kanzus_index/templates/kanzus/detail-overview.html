{%extends "global/tabbed-project/../../../alcf_data_portal/templates/global/tabbed-project/detail-base.html" %}
{% load static humanize %}

{% block headextras %}
<script type="text/javascript" src="{% static 'js/../../../alcf_data_portal/static/js/general-preview.js' %}"></script>
<link rel="stylesheet" type="text/css" href="/static/css/search.css" />
<script>
  // Disable Column Truncation
  // TRUNCATE_TABULAR_DATA_COLUMNS = 0;

  let rfmFiles = [
  {% for file in all_preview %}
    {
      'id': '{{file.id}}',
      'url': '{{file.url}}',
      'mimetype': '{{file.mime_type|default:"image/png"}}',
      'previewBytes': '{{file.field_metadata.previewbytes}}',
    },
  {% endfor %}
  ]
  function f(file, name) {
      getAccessToken("{% url 'access_token' %}", "{{resource_server}}")
      .then(token => loadContent(file, token, name))
  }

  for (var i = 0; i < rfmFiles.length; i++) {f(rfmFiles[i], 'preview-content-' + rfmFiles[i]['id'])}
</script>
<style>
@media print {
  .row {
    page-break-before: always;
  }
}
</style>
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a class="h5" href="{% url 'index-selection' %}">{{globus_portal_framework.project_title}}</a></li>
<li class="breadcrumb-item"><a class="h5" href="{% url 'tp-landing-page' index=globus_portal_framework.index %}">{{globus_portal_framework.index_data.name}}</a></li>
<li class="breadcrumb-item"><a class="h5" href="{% url 'tp-project-search' index=globus_portal_framework.index project=project %}">{{project_info.title}} Search</a></li>
<li class="breadcrumb-item active"><a class="h5">{{title|default:'Search Result'}}</a></li>
{% endblock %}

{% block detail_back_to_search %}
<div class="container mt-3">
  <div class="row">
    <div class="col-md-12">
      <div class="alert alert-info" role="alert">
        <a href="{% url 'tp-project-search' globus_portal_framework.index project %}?{{request.session.search.full_query}}">Back to Search</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block copy_to_clipboard %}
{% include 'global/components/../../../alcf_data_portal/templates/global/components/copy-to-clipboard.html' %}
{# include 'kanzus/global/tabbed-project/components/detail-overview/reprocess-form.html' #}
{% endblock %}

{% block detail_body %}


<div class="row">

  <div class="col-md-1"></div>
  <div class="col-md-10">
    <div class="card mt-3" style="">
      <div id="preview-content-{{listing_preview.id}}"></div>
      <!--<div class="card-body">-->
        <!--<p class="card-text">{{listing_preview.caption}}</p>-->
      <!--</div>-->
    </div>
  </div>
  <div class="col-md-1"></div>

  <div class="col-md-1"></div>
  <div class="col-md-10">
  {% include 'kanzus/global/tabbed-project/components/detail-overview/reprocess-list.html' %}
  </div>
  <div class="col-md-1"></div>

  <div class="col-md-12 text-center">
    <h3 class="mb-3 h3"><a name="summary">Summary</a></h3>
  </div>

  <div class="col-md-1"></div>
  <div class="col-md-10">
    <div class="alert alert-secondary" role="alert">
      <p>{{description|default:'No description was provided for this entry.'}}</p>
    </div>
  </div>
  <div class="col-md-1"></div>

  <div class="col-md-1"></div>
  <div class="col-md-5">{% include 'xpcs/global/tabbed-project/components/detail-overview/dc-metadata.html' %}</div>
  <div class="col-md-5">
    <table class="table table-striped table-bordered">
      <tbody>
      {% for result in detail_results %}
      <tr>
        <td>{{result.name}}</td>
        {% if result.type == 'int' %}
        <td>{{result.value|intcomma}}</td>
        {% elif result.type == 'filesize' %}
        <td>{{result.value|filesizeformat}}</td>
        {% elif result.type == 'range' %}
        <td>{{result.value.from}} - {{result.value.to}}</td>
        {% elif result.type == 'percentage' %}
        <td>{{result.value|floatformat:1}}%</td>
        {% else %}
        <td>{{result.value}}</td>
        {% endif %}
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="col-md-1"></div>

  <!--<div class="col-md-1"></div>-->
  <!--<div class="col-md-10">-->
    <!--<h3 class="text-center mb-3 h3">Batch Runs</h3>-->
    <!--<table class="table table-striped table-bordered">-->
      <!--<tbody>-->

        <!--{% for batch in batch_runs %}-->
          <!--{% if forloop.first %}-->
          <!--<tr>-->
          <!--{% for item in batch %}-->
            <!--<td>{{item.name}}</td>-->
          <!--{% endfor %}-->
          <!--</tr>-->
          <!--{% endif %}-->
        <!--{% endfor %}-->

        <!--{% for batch in batch_runs %}-->
          <!--<tr>-->
          <!--{% for item in batch %}-->
            <!--{% if item.type == 'image' %}-->
            <!--<td class="px-0 py-0 mx-0 my-0" style="width: 40%; height=40%" id="preview-content-{{item.value}}"></td>-->
            <!--{% elif item.type == 'range' %}-->
            <!--<td>{{item.value.from}} - {{item.value.to}}</td>-->
            <!--{% elif item.type == 'percentage' %}-->
            <!--<td>{{item.value|floatformat:1}}%</td>-->
            <!--{% else %}-->
            <!--<td>{{item.value}}</td>-->
            <!--{% endif %}-->
          <!--{% endfor %}-->
          <!--</tr>-->
        <!--{% endfor %}-->
      <!--</tbody>-->
    <!--</table>-->
  <!--</div>-->
  <!--<div class="col-md-1"></div>-->
</div>

{% if other_previews %}
<div class="row">
  <div class="col-md-12 text-center">
    <h2><a name="correlation_preview">Other Previews</a></h2>(<a href="#top">Top</a>)<br>
  </div>
</div>
{% for image_data in other_previews %}
<div class="row">
  <div class="col-md-12">
    <div class="card mt-3" style="">
      <div id="preview-content-{{image_data.id}}"></div>
      <div class="card-body">
        <p class="card-text">{{image_data.caption}}</p>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endif %}

<div class="row">
  <div class="col-md-12 text-center">
    <h2><a name="correlation_preview">Incremental (non-composited) CBF Images</a></h2>(<a href="#top">Top</a>)<br>
  </div>
</div>
{% for image_data in non_composite_batch_previews %}
<div class="row">
  <div class="col-md-12">
    <div class="card mt-3" style="">
      <div id="preview-content-{{image_data.id}}"></div>
      <div class="card-body">
        <p class="card-text">{{image_data.caption}}</p>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}